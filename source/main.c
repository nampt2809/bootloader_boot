/*
 * Copyright (c) 2013 - 2015, Freescale Semiconductor, Inc.
 * Copyright 2016-2017 NXP
 * All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */

#include "header_files.h"
/*******************************************************************************
 * Definitions
 ******************************************************************************/


static void hardwawre_init(void);
static void software_init(void);


//nampt

#define Start_Add_FLASH_EX 600000
#define ADD_FLEX 600100 
#define BUFFER_LEN 128
#define APP_FLASH_ADD_START 0x0c000

extern SYSTEM_VAR_T system_var;
static void sys_jumpApp(void);
static void sys_boot(void);
static void error_trap(void);

/*! @brief Flash driver Structure */
static flash_config_t s_flashDriver;
/*! @brief Buffer for program */
static uint32_t s_buffer[BUFFER_LEN];
/*! @brief Buffer for readback */
static uint32_t s_buffer_rbc[BUFFER_LEN];

uint8_t val_tran_1[] = {01};
uint8_t val_tran_0[] = {01};
uint32_t flash_read(uint32_t add);
uint8_t g_sector_index;
uint32_t cal_addr_sector(uint8_t sector_index);
uint32_t g_fault_flag;
uint8_t g_buffer_flashEX[512];
uint8_t sample_file[]={0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
                       
                       0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
                       
                       0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
                       
                       0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
                       
                       0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
                       
                       0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
                       
                       0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
                       
                       0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
                       0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
                       0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
                       0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
                       0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
                       0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
                       0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
                       0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
};

/*******************************************************************************
 * Prototypes
 ******************************************************************************/

/*******************************************************************************
 * Code
 ******************************************************************************/
/*!
 * @brief Main function
 */
volatile bool ftm_isr_flag = false;
volatile uint32_t g_systickCounter;

void SysTick_Handler(void)
{
    if (g_systickCounter != 0U)
    {
        
    }
}

void SysTick_DelayTicks(uint32_t n)
{
    g_systickCounter = n;
    while (g_systickCounter != 0U)
    {
      g_systickCounter--;
    }
}

///=============================================================================
int main(void)
{
    ///1. init system===========================================================
    hardwawre_init();
    software_init();
  
    /* Set systick reload value to generate 1ms interrupt */
    //nampt
    
    
    flash_erase_sector(USER_SPI1_MASTER,Start_Add_FLASH_EX);
    
    flash_write_buffer(USER_SPI1_MASTER, val_tran_1, Start_Add_FLASH_EX,1);
    flash_read_buffer(USER_SPI1_MASTER,&system_var.UpdateFirmWare_Flag, Start_Add_FLASH_EX,1);
    flash_read_buffer(USER_SPI1_MASTER,&system_var.addr, Start_Add_FLASH_EX+10,1);
    flash_read_buffer(USER_SPI1_MASTER,&system_var.num_byte, Start_Add_FLASH_EX+20,1);
    flash_read_buffer(USER_SPI1_MASTER,&system_var.crc32CHECK, Start_Add_FLASH_EX+30,1);
    if(system_var.UpdateFirmWare_Flag == 1){
      sys_boot();
    }
    else{
      sys_jumpApp();
    }
}
///1. hardwawre_init============================================================
static void hardwawre_init(void){
  /* Init board hardware. */
  BOARD_InitBootPins();
  BOARD_InitBootClocks();
  BOARD_InitDebugConsole();
}
///2.software_init==============================================================
static void software_init(void){
  //init_timer(USER_FTM2_BASEADDR,USER_FTM2_IRQ_NUM,TIMER_PERIOD_MS);
  //init_rs485(USER_UART2,USER_UART2_IRQn,9600);
  init_flash(USER_SPI1_MASTER);
  init_rtc(RTC_SDA_PORT,RTC_SDA_PIN,RTC_SCL_PORT,RTC_SCL_PIN,MS);
}

//nampt
static void sys_boot(void){
    status_t result;    /* Return code from each flash driver function */
    uint32_t destAdrss; /* Address of the target location */
    uint32_t i;
    
    uint32_t pflashBlockBase;
    uint32_t pflashTotalSize;
    uint32_t pflashSectorSize;
    
    //----------------------------------------INIT FLASh----------------------------------------------//
    /* Clean up Flash driver Structure*/
    memset(&s_flashDriver, 0, sizeof(flash_config_t));
    FLASH_SetProperty(&s_flashDriver, kFLASH_PropertyFlashClockFrequency, 20000000U);
    result = FLASH_Init(&s_flashDriver);
    if (kStatus_FLASH_Success != result)
    {
        error_trap();
    }
    pflashBlockBase  = s_flashDriver.PFlashBlockBase;
    pflashTotalSize  = s_flashDriver.PFlashTotalSize;
    pflashSectorSize = s_flashDriver.PFlashSectorSize;
    
    
    //--------------------------------------ERASE FLASH INTERNAL-----------------------------------------//
//#ifndef SECTOR_INDEX_FROM_END
//#define SECTOR_INDEX_FROM_END 10U
//#endif
//
///* Erase a sector from destAdrss. */
//#if defined(FSL_FEATURE_FLASH_HAS_PFLASH_BLOCK_SWAP) && FSL_FEATURE_FLASH_HAS_PFLASH_BLOCK_SWAP
//    /* Note: we should make sure that the sector shouldn't be swap indicator sector*/
//    destAdrss = pflashBlockBase + (pflashTotalSize - (SECTOR_INDEX_FROM_END * pflashSectorSize * 2));
//#else
//    destAdrss = pflashBlockBase + (pflashTotalSize - (SECTOR_INDEX_FROM_END * pflashSectorSize));
//#endif
    //--------------------------------------READ FLASH_EXTERNAL-----------------------------------------//
    /*breaf
    s_buffer: buffer de ghi vao flash noi
    g_buffer_flashEX: doc tu flash ngoai ve
*/
    /* Prepare user buffer. */
    
    flash_erase_sector(USER_SPI1_MASTER,ADD_FLEX);  
    flash_write_buffer(USER_SPI1_MASTER, sample_file, ADD_FLEX,512);
    crc32cal_Init();
    uint32_t positionFirm = ADD_FLEX;
    uint32_t des_position = APP_FLASH_ADD_START;
    uint32_t current_pos = 0 ;
    uint32_t j= 0;
    if(FLASH_Erase(&s_flashDriver, APP_FLASH_ADD_START, pflashSectorSize, kFLASH_ApiEraseKey)== kStatus_FLASH_Success)
    {
      do{
        
        flash_read_buffer(USER_SPI1_MASTER,g_buffer_flashEX,positionFirm,400);
        for(i=0;i<128;i++)
        {
          s_buffer[i]=g_buffer_flashEX[j]|g_buffer_flashEX[1+j]<<8|g_buffer_flashEX[j+2]<<16|g_buffer_flashEX[j+3]<<24;
          j=j+4;
        }
        FLASH_Erase(&s_flashDriver, des_position, pflashSectorSize, kFLASH_ApiEraseKey);
      if(FLASH_Program(&s_flashDriver, des_position, s_buffer, sizeof(s_buffer)) == kStatus_FLASH_Success)
      {
        des_position += 512;
      }
      
      current_pos +=512;
      positionFirm+= 512;
      uint32_t test_var =0;
      
      /* APPPPPPPPPPPPPPPPP CHECKKKKKK--------------------*/
//      if(current_pos<1024)// TONG SO BYTE 
//      { 
//        crc32cal_WriteData(g_buffer_flashEX,512);
//      }
//      else{
//        test_var = current_pos%512;
//        crc32cal_WriteData(g_buffer_flashEX,test_var);}
      }while(current_pos<1024); //TONG SO BYTE 
    }
//    if(system_var.crc32CHECK == crc32cal_Get32bitResult())
//    {
      system_var.UpdateFirmWare_Flag = 0;
      flash_write_buffer(USER_SPI1_MASTER,val_tran_0,Start_Add_FLASH_EX,1);
      NVIC_SystemReset();
      
//    }
//    else 
//    {
//      system_var.UpdateFirmWare_Flag = 1;
//      NVIC_SystemReset();
//    }
    /* Program user buffer into flash*/
    /* Verify programming by reading back from flash directly*/
   
    for(uint32_t k = 0;k<512;k++)
    {
      s_buffer_rbc[k] = *(volatile uint32_t *)(APP_FLASH_ADD_START+k*4);
    }
    FLASH_Erase(&s_flashDriver, destAdrss, pflashSectorSize, kFLASH_ApiEraseKey);    
}
static void sys_jumpApp(void){
  uint32_t startup = APP_FLASH_ADD_START;
   ((void(*)(void))startup)(); /* Jump to application startup code */
}

static void error_trap(void)
{
    while (1)
    {
    }
}

