/*
* Copyright (c) 2013 - 2015, Freescale Semiconductor, Inc.
* Copyright 2016-2017 NXP
* All rights reserved.
*
* SPDX-License-Identifier: BSD-3-Clause
*/

#include "header_files.h"
/*******************************************************************************
* Definitions
******************************************************************************/


static void hardwawre_init(void);
static void software_init(void);


//nampt

#define Start_Add_FLASH_EX 0x600000
#define BUFFER_LEN 128
#define APP_FLASH_ADD_START 0x00008000


extern SYSTEM_VAR_T system_var;
static void sys_jumpApp(void);
static void sys_boot(void);
static void error_trap(void);

/*! @brief Flash driver Structure */
static flash_config_t s_flashDriver;
/*! @brief Buffer for program */
static uint32_t s_buffer[BUFFER_LEN];
/*! @brief Buffer for readback */
uint8_t UpdateFirmWare_Flag = 0;
uint8_t val_tran_1[] = {01};
uint8_t val_tran_0[] = {01};
uint32_t flash_read(uint32_t add);
uint8_t g_sector_index;
uint32_t cal_addr_sector(uint8_t sector_index);
uint32_t g_fault_flag;
uint8_t g_buffer_flashEX[512];
uint8_t sample_file[]={0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,

0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,

0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,

0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,

0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,

0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,

0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,

0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,
0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,
0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,
0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,
0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A,0x5B,0x5C,0x5D,0x5E,0x5F,
0x60,0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,
0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7A,0x7B,0x7C,0x7D,0x7E,0x7F,
};

/*******************************************************************************
* Prototypes
******************************************************************************/

/*******************************************************************************
* Code
******************************************************************************/
/*!
* @brief Main function
*/
volatile bool ftm_isr_flag = false;
volatile uint32_t g_systickCounter;

uint32_t positionFirm = Start_Add_FLASH_EX;
uint32_t des_position = APP_FLASH_ADD_START;
uint32_t current_pos = 0 ;
//    uint32_t j,k= 0;
uint32_t i,j=0;
uint32_t Re_Num = 0, Im_Num = 0;
void SysTick_Handler(void)
{
  if (g_systickCounter != 0U)
  {
    
  }
}

void SysTick_DelayTicks(uint32_t n)
{
  g_systickCounter = n;
  while (g_systickCounter != 0U)
  {
    g_systickCounter--;
  }
}

///=============================================================================
int main(void)
{
  ///1. init system===========================================================
  hardwawre_init();
  software_init();
  
  /* Set systick reload value to generate 1ms interrupt */
  //nampt
  
  
  //flash_erase_sector(USER_SPI1_MASTER,0x00);
  //    flash_write_buffer(USER_SPI1_MASTER, val_tran_1, Start_Add_FLASH_EX,1);
  flash_read_buffer(USER_SPI1_MASTER,&system_var.u8NewFirmFlag1, 0x0000,1);
  flash_read_buffer(USER_SPI1_MASTER,&system_var.u8NewFirmFlag2, 0x0001,1);
  flash_read_buffer(USER_SPI1_MASTER,&system_var.u8NewFirmFlag3, 0x0002,1);
  uint8_t length1,length2,length3,length4;
  flash_read_buffer(USER_SPI1_MASTER,&length1, 0x03,1);
  flash_read_buffer(USER_SPI1_MASTER,&length2, 0x04,1); //do dai file update
  flash_read_buffer(USER_SPI1_MASTER,&length3, 0x08,1);
  flash_read_buffer(USER_SPI1_MASTER,&length4, 0x09,1); //do dai file update
  system_var.num_byte = (uint32_t)(length1) | (uint32_t)(length2<<8)| (uint32_t)(length3<<16)| (uint32_t)(length4<<24);
  if(((system_var.u8NewFirmFlag1 == 1)&&(system_var.u8NewFirmFlag2 == 1))&&(system_var.u8NewFirmFlag3 == 1)){
    sys_boot();
  }
  else{
    sys_jumpApp();
  }
}
///1. hardwawre_init============================================================
static void hardwawre_init(void){
  /* Init board hardware. */
  BOARD_InitBootPins();
  BOARD_InitBootClocks();
  BOARD_InitDebugConsole();
}
///2.software_init==============================================================
static void software_init(void){
  //init_timer(USER_FTM2_BASEADDR,USER_FTM2_IRQ_NUM,TIMER_PERIOD_MS);
  //init_rs485(USER_UART2,USER_UART2_IRQn,9600);
  init_flash(USER_SPI1_MASTER);
  init_rtc(RTC_SDA_PORT,RTC_SDA_PIN,RTC_SCL_PORT,RTC_SCL_PIN,MS);
}

//nampt
static void sys_boot(void){
  status_t result;    /* Return code from each flash driver function */
  uint32_t pflashSectorSize;
  
  //----------------------------------------INIT FLASh----------------------------------------------//
  /* Clean up Flash driver Structure*/
  memset(&s_flashDriver, 0, sizeof(flash_config_t));
  FLASH_SetProperty(&s_flashDriver, kFLASH_PropertyFlashClockFrequency, 20000000U);
  result = FLASH_Init(&s_flashDriver);
  if (kStatus_FLASH_Success != result)
  {
    error_trap();
  }
  
  pflashSectorSize = s_flashDriver.PFlashSectorSize; //512
  
  
  //--------------------------------------ERASE FLASH INTERNAL-----------------------------------------//
  
  ///* Erase a sector from destAdrss. */
  
  
  
  Re_Num = (uint32_t)system_var.num_byte / 512;
  Im_Num = (uint32_t)system_var.num_byte % 512;
  if(FLASH_Erase(&s_flashDriver, APP_FLASH_ADD_START, pflashSectorSize, kFLASH_ApiEraseKey)== kStatus_FLASH_Success)
  {
    
    if(Re_Num > 0){
      do{
        GPIO_PortToggle(BOARD_RUN_LED_GPIO_PORT, 1u << BOARD_RUN_LED_PIN);
        flash_read_buffer(USER_SPI1_MASTER,g_buffer_flashEX,positionFirm,pflashSectorSize);
        for(i=0;i<128;i++)
        {
          s_buffer[i]=g_buffer_flashEX[j]|g_buffer_flashEX[1+j]<<8|g_buffer_flashEX[j+2]<<16|g_buffer_flashEX[j+3]<<24;
          j=j+4;
        }
        j=0;
        FLASH_Erase(&s_flashDriver, des_position, pflashSectorSize, kFLASH_ApiEraseKey);
        
        if(FLASH_Program(&s_flashDriver, des_position, s_buffer, sizeof(s_buffer)) == kStatus_FLASH_Success)
        {
          des_position += 512;
          current_pos +=1;
          positionFirm+= 512;
        }       
      }while(current_pos < Re_Num);
    } 
    
    if(Im_Num > 0){
      
      
      GPIO_PortToggle(BOARD_RUN_LED_GPIO_PORT, 1u << BOARD_RUN_LED_PIN);
      flash_read_buffer(USER_SPI1_MASTER,g_buffer_flashEX,positionFirm,pflashSectorSize);
      i=0;j=0;
      for(i=0;i<128;i++)
      {
        s_buffer[i]=g_buffer_flashEX[j]|g_buffer_flashEX[1+j]<<8|g_buffer_flashEX[j+2]<<16|g_buffer_flashEX[j+3]<<24;
        j=j+4;
      }
      j=0;
      
      FLASH_Erase(&s_flashDriver, des_position, pflashSectorSize, kFLASH_ApiEraseKey);
      FLASH_Program(&s_flashDriver, des_position, s_buffer, sizeof(s_buffer) == kStatus_FLASH_Success);
      
    }
    //system_var.UpdateFirmWare_Flag = 0;
    system_var.u8NewFirmFlag1 =0;
    system_var.u8NewFirmFlag2=0;
    system_var.u8NewFirmFlag3=0;
    UpdateFirmWare_Flag =1;
    flash_write_buffer(USER_SPI1_MASTER,&system_var.u8NewFirmFlag1,0x00,1);
    flash_write_buffer(USER_SPI1_MASTER,&system_var.u8NewFirmFlag2,0x01,1);
    flash_write_buffer(USER_SPI1_MASTER,&system_var.u8NewFirmFlag3,0x02,1);
    flash_write_buffer(USER_SPI1_MASTER,&UpdateFirmWare_Flag,0xA,1);
    
    NVIC_SystemReset();
  }
}
static void sys_jumpApp(void){
  uint32_t appEntry =(*(unsigned int*)0x8004);
  uint32_t appStack = (*(unsigned int*)0x8000);
  static void (*farewellBootloader)(void) = 0;
  farewellBootloader = (void (*)(void))appEntry ;
  
  
  SCB->VTOR = 0x8000;
  
  // Set stack pointers to the application stack pointer.
  __set_MSP(appStack );
  __set_PSP(appStack );
  
  // Jump to the application.
  farewellBootloader();
}

static void error_trap(void)
{
  while (1)
  {
  }
}

